---
import BaseLayout from '../layouts/BaseLayout.astro';
import { oauth } from '../lib/oauth';
import SecretToggle from '../components/ui/SecretToggle';
import Clipboard from '../components/ui/Clipboard';

export const prerender = false;

// Obtener todos los clients, codes y tokens
const clients = [];
for await (const client of oauth.listClients()) {
	clients.push(client);
}

const codes = [];
for await (const code of oauth.listCodes()) {
	codes.push(code);
}

const tokens = [];
for await (const token of oauth.listTokens()) {
	tokens.push(token);
}
---

<BaseLayout title="OAuth Provider - Dashboard" description="OAuth Provider Dashboard">
	<div class="w-full max-w-6xl space-y-6 md:space-y-8 px-4 sm:px-6 lg:px-8">
		<h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-4 md:mb-6">OAuth Provider Dashboard</h1>

		<!-- OAuth Endpoints Section -->
		<div class="bg-white shadow-md rounded-lg p-4 sm:p-6">
			<h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-3 sm:mb-4">OAuth Endpoints</h2>
			<div class="space-y-3">
				<div class="flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-0">
					<span class="font-semibold text-gray-700 text-sm sm:text-base">Authorization URI:</span>
					<Clipboard value={`${Astro.url.origin}/authorize`} client:load>
						<code class="text-blue-600 font-mono text-xs sm:text-sm break-all">{Astro.url.origin}/authorize</code>
					</Clipboard>
				</div>
				<div class="flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-0">
					<span class="font-semibold text-gray-700 text-sm sm:text-base">Token URI:</span>
					<Clipboard value={`${Astro.url.origin}/api/token`} client:load>
						<code class="text-blue-600 font-mono text-xs sm:text-sm break-all">{Astro.url.origin}/api/token</code>
					</Clipboard>
				</div>
			</div>
		</div>

		<!-- Clients Section -->
		<div class="bg-white shadow-md rounded-lg p-4 sm:p-6">
			<h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-3 sm:mb-4">OAuth Clients ({clients.length})</h2>
			{clients.length === 0 ? (
				<p class="text-gray-600 text-sm sm:text-base">No clients found. Run database seed to create a default client.</p>
			) : (
				<div class="overflow-x-auto -mx-4 sm:mx-0">
					<table class="w-full min-w-full">
						<thead>
							<tr class="border-b-2 border-gray-200">
								<th class="text-left py-2 sm:py-3 px-2 sm:px-4 font-semibold text-gray-700 text-sm sm:text-base">Client ID</th>
								<th class="text-left py-2 sm:py-3 px-2 sm:px-4 font-semibold text-gray-700 text-sm sm:text-base">Client Secret</th>
							</tr>
						</thead>
						<tbody>
							{clients.map((client) => (
								<tr class="border-b border-gray-100 hover:bg-gray-50">
									<td class="py-2 sm:py-3 px-2 sm:px-4 text-gray-800 font-mono text-xs sm:text-sm break-all">
										<Clipboard value={client.client_id} client:load>
											<span>{client.client_id}</span>
										</Clipboard>
									</td>
									<td class="py-2 sm:py-3 px-2 sm:px-4 text-gray-800">
										<div class="flex items-center gap-2">
											<SecretToggle value={client.client_secret} client:load />
											<Clipboard value={client.client_secret} client:load>
												<span></span>
											</Clipboard>
										</div>
									</td>
								</tr>
							))}
						</tbody>
					</table>
				</div>
			)}
		</div>

		<!-- Codes Section -->
		<div class="bg-white shadow-md rounded-lg p-4 sm:p-6">
			<h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-3 sm:mb-4">Authorization Codes ({codes.length})</h2>
			{codes.length === 0 ? (
				<p class="text-gray-600 text-sm sm:text-base">No authorization codes found.</p>
			) : (
				<div class="overflow-x-auto -mx-4 sm:mx-0">
					<table class="w-full min-w-full">
						<thead>
							<tr class="border-b-2 border-gray-200">
								<th class="text-left py-2 sm:py-3 px-2 sm:px-4 font-semibold text-gray-700 text-sm sm:text-base">Code ID</th>
								<th class="text-left py-2 sm:py-3 px-2 sm:px-4 font-semibold text-gray-700 text-sm sm:text-base hidden md:table-cell">Client ID</th>
								<th class="text-left py-2 sm:py-3 px-2 sm:px-4 font-semibold text-gray-700 text-sm sm:text-base hidden lg:table-cell">Callback URL</th>
								<th class="text-left py-2 sm:py-3 px-2 sm:px-4 font-semibold text-gray-700 text-sm sm:text-base">Scope</th>
							</tr>
						</thead>
						<tbody>
							{codes.map((code) => (
								<tr class="border-b border-gray-100 hover:bg-gray-50">
									<td class="py-2 sm:py-3 px-2 sm:px-4 text-gray-800 font-mono text-xs sm:text-sm break-all">{code.code_id}</td>
									<td class="py-2 sm:py-3 px-2 sm:px-4 text-gray-800 font-mono text-xs sm:text-sm hidden md:table-cell">{code.client_id}</td>
									<td class="py-2 sm:py-3 px-2 sm:px-4 text-gray-800 font-mono text-xs sm:text-sm break-all hidden lg:table-cell">{code.callback_url}</td>
									<td class="py-2 sm:py-3 px-2 sm:px-4 text-gray-800 font-mono text-xs sm:text-sm">{code.scope}</td>
								</tr>
							))}
						</tbody>
					</table>
				</div>
			)}
		</div>

		<!-- Tokens Section -->
		<div class="bg-white shadow-md rounded-lg p-4 sm:p-6">
			<h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-3 sm:mb-4">Access Tokens ({tokens.length})</h2>
			{tokens.length === 0 ? (
				<p class="text-gray-600 text-sm sm:text-base">No access tokens found.</p>
			) : (
				<div class="overflow-x-auto -mx-4 sm:mx-0">
					<table class="w-full min-w-full">
						<thead>
							<tr class="border-b-2 border-gray-200">
								<th class="text-left py-2 sm:py-3 px-2 sm:px-4 font-semibold text-gray-700 text-sm sm:text-base">Access Token</th>
								<th class="text-left py-2 sm:py-3 px-2 sm:px-4 font-semibold text-gray-700 text-sm sm:text-base hidden md:table-cell">Token Type</th>
								<th class="text-left py-2 sm:py-3 px-2 sm:px-4 font-semibold text-gray-700 text-sm sm:text-base hidden lg:table-cell">Scope</th>
								<th class="text-left py-2 sm:py-3 px-2 sm:px-4 font-semibold text-gray-700 text-sm sm:text-base hidden xl:table-cell">Refresh Token</th>
							</tr>
						</thead>
						<tbody>
							{tokens.map((token) => (
								<tr class="border-b border-gray-100 hover:bg-gray-50">
									<td class="py-2 sm:py-3 px-2 sm:px-4 text-gray-800 font-mono text-xs sm:text-sm break-all">{token.access_token}</td>
									<td class="py-2 sm:py-3 px-2 sm:px-4 text-gray-800 font-mono text-xs sm:text-sm hidden md:table-cell">{token.token_type}</td>
									<td class="py-2 sm:py-3 px-2 sm:px-4 text-gray-800 font-mono text-xs sm:text-sm hidden lg:table-cell">{token.scope}</td>
									<td class="py-2 sm:py-3 px-2 sm:px-4 text-gray-800 font-mono text-xs sm:text-sm break-all hidden xl:table-cell">{token.refresh_token}</td>
								</tr>
							))}
						</tbody>
					</table>
				</div>
			)}
		</div>
	</div>
</BaseLayout>
