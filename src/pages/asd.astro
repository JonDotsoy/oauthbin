---
import "../styles/global.css";

export const prerender = false;

// Handle POST request
if (Astro.request.method === "POST") {
  const formData = await Astro.request.formData();
  const email = formData.get("email") as string;
  
  if (email) {
    // Get existing emails from cookie
    const existingEmailsJson = Astro.cookies.get("user_emails")?.value;
    let emailList: string[] = [];
    
    if (existingEmailsJson) {
      try {
        emailList = JSON.parse(existingEmailsJson);
      } catch (e) {
        emailList = [];
      }
    }
    
    // Add new email if it doesn't exist
    if (!emailList.includes(email)) {
      emailList.unshift(email); // Add to beginning of array
    } else {
      // Move existing email to the front
      emailList = [email, ...emailList.filter(e => e !== email)];
    }
    
    // Save updated list to cookie
    Astro.cookies.set("user_emails", JSON.stringify(emailList), {
      path: "/",
      maxAge: 60 * 60 * 24 * 365, // 1 year
      sameSite: "lax"
    });
  }
}

// Get emails from cookie if exists
const savedEmailsJson = Astro.cookies.get("user_emails")?.value;
let savedEmails: string[] = [];

if (savedEmailsJson) {
  try {
    savedEmails = JSON.parse(savedEmailsJson);
  } catch (e) {
    savedEmails = [];
  }
}

// I18n translations
const translations = {
  en: {
    signIn: "Sign in",
    withAccount: "with your Account. This account will be available to other apps in the browser.",
    emailOrPhone: "Email or phone",
    forgotEmail: "Forgot email?",
    notYourComputer: "Not your computer? Use Guest mode to sign in privately.",
    learnMore: "Learn more about using Guest mode",
    createAccount: "Create account",
    next: "Login",
    language: "English (United States)",
    footer: "oauthbin"
  },
  es: {
    signIn: "Iniciar sesión",
    withAccount: "con tu cuenta. Esta cuenta estará disponible para otras aplicaciones en el navegador.",
    emailOrPhone: "Correo electrónico o teléfono",
    forgotEmail: "¿Olvidaste tu correo electrónico?",
    notYourComputer: "¿No es tu computadora? Usa el modo de invitado para iniciar sesión de forma privada.",
    learnMore: "Más información sobre el modo de invitado",
    createAccount: "Crear cuenta",
    next: "Iniciar sesión",
    language: "Español",
    footer: "oauthbin"
  }
};

// Get language from query param or default to 'en'
const lang = (Astro.url.searchParams.get("lang") || "en") as keyof typeof translations;
const t = translations[lang] || translations.en;
---

<!doctype html>
<html lang={lang}>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>Sign in</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
      body {
        font-family: 'Roboto', 'Helvetica', 'Arial', sans-serif;
      }
    </style>
  </head>
  <body class="min-h-screen bg-[#f5f5f5] flex items-center justify-center p-4">
    <div class="w-full max-w-[450px]">
      <!-- Main card -->
      <div class="bg-white rounded-lg shadow-[0_2px_4px_rgba(0,0,0,0.1),0_8px_16px_rgba(0,0,0,0.1)] border border-[#dadce0] px-10 py-12">
        <!-- Sign in header -->
        <div class="mb-6">
          <h1 class="text-[24px] font-normal text-[#202124] mb-2 leading-tight">{t.signIn}</h1>
          <p class="text-[14px] text-[#5f6368] leading-[1.4]">{t.withAccount}</p>
        </div>

        <!-- Form -->
        <form method="POST" class="mt-8">
          <!-- Email input -->
          <div class="mb-6">
            {savedEmails.length > 0 && (
              <div class="mb-4 space-y-2">
                {savedEmails.map((email) => (
                  <div class="p-4 border border-[#dadce0] rounded-[4px] hover:border-[#202124] cursor-pointer transition-all" onclick={`document.getElementById('email').value = '${email}'`}>
                    <div class="text-[14px] text-[#5f6368] mb-1">Saved account</div>
                    <div class="text-[16px] text-[#202124] font-medium">{email}</div>
                  </div>
                ))}
              </div>
            )}
            <div class="relative border border-[#dadce0] rounded-[4px] hover:border-[#202124] focus-within:border-[#1a73e8] focus-within:border-2 transition-all">
              <input
                type="text"
                id="email"
                name="email"
                value=""
                class="w-full px-4 pt-[22px] pb-[6px] text-[16px] text-[#202124] bg-transparent outline-none rounded-[4px]"
              />
              <label 
                for="email"
                class="absolute left-4 top-2 text-[11px] text-[#5f6368] pointer-events-none"
              >
                {t.emailOrPhone}
              </label>
            </div>
          </div>

          <!-- Guest mode info -->
          <div class="text-[14px] text-[#5f6368] leading-[1.4] mb-8">
            <p>{t.notYourComputer}</p>
          </div>

          <!-- Action buttons -->
          <div class="flex justify-end items-center">
            <button
              type="submit"
              class="bg-[#1a73e8] hover:bg-[#1765cc] active:bg-[#1557b0] text-white font-medium px-6 py-[10px] rounded-[4px] text-[14px] shadow-[0_1px_2px_0_rgba(60,64,67,0.3),0_1px_3px_1px_rgba(60,64,67,0.15)] hover:shadow-[0_1px_3px_0_rgba(60,64,67,0.3),0_4px_8px_3px_rgba(60,64,67,0.15)] transition-all"
            >
              {t.next}
            </button>
          </div>
        </form>
      </div>

      <!-- Footer -->
      <footer class="mt-10 px-4 flex justify-between items-center text-[12px] text-[#5f6368]">
        <div class="relative">
          <select 
            class="appearance-none bg-transparent pr-5 py-1 cursor-pointer outline-none hover:bg-[#f1f3f4] rounded-[4px] px-2 transition-colors"
            onchange="window.location.href = '?lang=' + this.value"
          >
            <option value="en" selected={lang === "en"}>English (United States)</option>
            <option value="es" selected={lang === "es"}>Español</option>
          </select>
          <svg class="absolute right-0 top-1/2 -translate-y-1/2 w-4 h-4 pointer-events-none text-[#5f6368]" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
          </svg>
        </div>
        <div>
          <span class="text-[#202124]">{t.footer}</span>
        </div>
      </footer>
    </div>
  </body>
</html>
