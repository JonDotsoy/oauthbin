---
import BaseLayout from "../layouts/BaseLayout.astro";

export const prerender = false;

const response_type = Astro.url.searchParams.get("response_type") ?? null;
const client_id = Astro.url.searchParams.get("client_id") ?? null;
const redirect_uri = Astro.url.searchParams.get("redirect_uri") ?? null;
const scope = Astro.url.searchParams.get("scope") ?? null;
const state = Astro.url.searchParams.get("state") ?? null;

// Validar que todos los parámetros requeridos estén presentes
if (!response_type || !client_id || !redirect_uri || !scope || !state) {
    const missingParams = [];
    if (!response_type) missingParams.push("response_type");
    if (!client_id) missingParams.push("client_id");
    if (!redirect_uri) missingParams.push("redirect_uri");
    if (!scope) missingParams.push("scope");
    if (!state) missingParams.push("state");

    return Response.json(
        {
            error: "invalid_request",
            error_description: `Missing required OAuth parameters: ${missingParams.join(", ")}`,
        },
        {
            status: 400,
        },
    );
}

// Validar response_type
if (response_type !== "code" && response_type !== "token") {
    return Response.json(
        {
            error: "unsupported_response_type",
            error_description: "Only 'code' and 'token' response types are supported",
        },
        {
            status: 400,
        },
    );
}

const usernamesWorkds: string[] = [
    "alice",
    "bob",
    "charlie",
    "david",
    "emma",
    "frank",
    "grace",
    "henry",
    "isabel",
    "jack",
    "kate",
    "liam",
    "maria",
    "noah",
    "olivia",
    "peter",
    "quinn",
    "rachel",
    "sam",
    "tina",
    "uma",
    "victor",
    "wendy",
    "xavier",
    "yara",
    "zack",
    "anna",
    "ben",
    "clara",
    "daniel",
    "eva",
    "felix",
    "gina",
    "hugo",
    "iris",
    "james",
    "karen",
    "leo",
    "maya",
    "nick",
    "oscar",
    "paula",
    "quincy",
    "rose",
    "steve",
    "tara",
    "ulysses",
    "vera",
    "walter",
    "xena",
    "yale",
    "zoe",
    "adam",
    "bella",
    "carl",
    "diana",
    "eric",
    "fiona",
    "george",
    "hannah",
];

const chars = "0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";
const randomName =
    usernamesWorkds[Math.floor(Math.random() * usernamesWorkds.length)];
const randomSuffix = Array.from(
    { length: 4 },
    () => chars[Math.floor(Math.random() * chars.length)],
).join("");
const randomUsername = `${randomName}-${randomSuffix}`;
---

<BaseLayout>
    <div class="w-full max-w-2xl space-y-8">
        <form action="/api/complete_authorize" method="post" class="bg-white shadow-md rounded-lg p-6 space-y-4">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Authorization</h2>

            <div>
                <label
                    for="username"
                    class="block text-sm font-medium text-gray-700 mb-2"
                    >Username:</label
                >
                <input
                    type="text"
                    id="username"
                    name="username"
                    value={randomUsername}
                    required
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                />
            </div>

            <input type="hidden" name="response_type" value={response_type} />
            <input type="hidden" name="client_id" value={client_id} />
            <input type="hidden" name="scope" value={scope} />
            <input type="hidden" name="state" value={state} />
            <input type="hidden" name="redirect_uri" value={redirect_uri} />

            <button
                type="submit"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition duration-200"
            >
                Login
            </button>
        </form>

        <div class="bg-white shadow-md rounded-lg p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">
                OAuth Parameters
            </h3>
            <table class="w-full">
                <thead>
                    <tr class="border-b border-gray-200">
                        <th
                            class="text-left py-2 px-4 font-semibold text-gray-700"
                            >Parameter</th
                        >
                        <th
                            class="text-left py-2 px-4 font-semibold text-gray-700"
                            >Value</th
                        >
                    </tr>
                </thead>
                <tbody>
                    <tr class="border-b border-gray-100">
                        <td class="py-2 px-4 text-gray-600">response_type</td>
                        <td class="py-2 px-4 text-gray-800 font-mono text-sm"
                            >{response_type}</td
                        >
                    </tr>
                    <tr class="border-b border-gray-100">
                        <td class="py-2 px-4 text-gray-600">client_id</td>
                        <td class="py-2 px-4 text-gray-800 font-mono text-sm"
                            >{client_id}</td
                        >
                    </tr>
                    <tr class="border-b border-gray-100">
                        <td class="py-2 px-4 text-gray-600">redirect_uri</td>
                        <td
                            class="py-2 px-4 text-gray-800 font-mono text-sm break-all"
                            >{redirect_uri}</td
                        >
                    </tr>
                    <tr class="border-b border-gray-100">
                        <td class="py-2 px-4 text-gray-600">scope</td>
                        <td class="py-2 px-4 text-gray-800 font-mono text-sm"
                            >{scope}</td
                        >
                    </tr>
                    <tr>
                        <td class="py-2 px-4 text-gray-600">state</td>
                        <td class="py-2 px-4 text-gray-800 font-mono text-sm"
                            >{state}</td
                        >
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</BaseLayout>
